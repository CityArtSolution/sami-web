<?phpnamespace App\Http\Controllers;use App\Services\TapPaymentService;use Illuminate\Http\Request;use Modules\Wallet\Models\Wallet;use Modules\Booking\Models\Booking;use App\Models\LoyaltyPoint;use App\Models\Invoice;use Modules\Booking\Models\BookingTransaction;use App\Models\Setting;class TapPaymentController extends Controller{    public function checkout(Request $request)    {        $tap = new TapPaymentService();        $user = auth()->user();        $amount = $request->amount;        $type   = $request->type;        $page_type   = $request->page;                 if (!in_array($type , ['cart' , 'deposit'])) {            return redirect()->back()->with('error', __('messages.invalid_type'));        }                if (!$amount || !is_numeric($amount)) {            return redirect()->back()->with('error', __('messages.invalid_amount'));        }        $charge = $tap->createCharge(            amount: $amount,            customerData: [                "name"         => $user->first_name . $user->last_name ,                "country_code" => "966",                "phone"        => $user->mobile            ],            redirectUrl: route('tap.callback', ['type' => $type, 'amount' => $amount, 'page_type' => $page_type])        );        if (!isset($charge['transaction']['url'])) {            return "Error: " . json_encode($charge);        }        return redirect($charge['transaction']['url']);    }        public function callback(Request $request)    {        $tap = new TapPaymentService();        $user = auth()->user();            $chargeId = $request->tap_id;        $amount = floatval($request->query('amount'));        $type = $request->query('type');        $page_type = $request->query('page_type');        $discountAmount = $request->query('discountAmount') ?? 0;        if (!$chargeId) {            return "خطأ: لم يتم العثور على معرف العملية tap_id";        }            $charge = $tap->getCharge($chargeId);                $failed = function($message, $sub = '', $redirect = null) {            $data = [ 'message' => $message, 'sub' => $sub];            if ($redirect) {                $data['redirect'] = $redirect;            }            return view('components.frontend.status.FAILED', $data);        };            $redirectToPayment = ($type === 'cart' && $page_type === 'payment');        if (!isset($charge['status'])) {            return $failed("خطأ غير متوقع: " . json_encode($charge), '', $redirectToPayment ? '/payment?ids=1' : null);        }            $status = $charge['status'];        switch ($status) {            case "CAPTURED":                if($type == 'deposit'){                    $wallet = Wallet::firstOrCreate(                        ['user_id' => auth()->id()],                        [                            'amount' => 0,                            'title' => auth()->user()->first_name . " " . auth()->user()->second_name,                        ]                    );                        $wallet->increment('amount', $amount);                }                                if($type == 'cart'){                    if($page_type == 'payment'){                        $cartIds = Booking::where('user_id', $user->id)->where('payment_status', 0)->where('payment_type', 'payment')->pluck('id')->toArray();                    }else{                        $cartIds = Booking::where('user_id', $user->id)->where('payment_status', 0)->where('payment_type', 'cart')->pluck('id')->toArray();                    }                    $this->addLoyaltyPoints($user->id, $amount);                    $this->storeInvoice($user->id, $discountAmount, $amount, $cartIds);                    $this->paymentSuccess( $cartIds ,  $chargeId , 'card');                    Booking::whereIn('id', $cartIds)->update(['payment_status' => 1]);                }                return view('components.frontend.status.CAPTURED');            case "FAILED":                if ($redirectToPayment) {                    return $failed("خطأ غير متوقع: " . json_encode($charge), '', '/payment?ids=1');                }                return $failed(__('messages.failed_status'), __('messages.failed_message'));            case "CANCELLED":                if ($redirectToPayment) {                    $cartIds = Booking::where('user_id', $user->id)->where('payment_status', 0)->where('payment_type', 'payment')->delete();                }                return $failed(__('messages.cancelled_status'), __('messages.cancelled_message'));                    case "INITIATED":                if ($redirectToPayment) {                    return $failed("خطأ غير متوقع: " . json_encode($charge), '', '/payment?ids=1');                }                    return $failed(__('messages.initiated_status'), __('messages.initiated_message'));            default:                if ($redirectToPayment) {                    return $failed("خطأ غير متوقع: " . json_encode($charge), '', '/payment?ids=1');                }                    return $failed(__('messages.unknown_status') . ": " . $status);        }    }        public function addLoyaltyPoints($userId, $paidAmount)    {        $points_per_100 = Setting::get('points_per_100') ?? 5;        $pointsToAdd = floor($paidAmount / 100) * $points_per_100;        if ($pointsToAdd <= 0) {            return;        }        $loyalty = LoyaltyPoint::firstOrNew(['user_id' => $userId]);        $loyalty->points = ($loyalty->points ?? 0) + $pointsToAdd;        $loyalty->save();    }    private function storeInvoice($userId, $discountAmount, $finalTotal, $cartIds)    {        Invoice::create([            'user_id' => $userId,            'cart_ids' => json_encode($cartIds),            'discount_amount' => $discountAmount,            'loyalty_points_discount' => 0,            'final_total' => $finalTotal,        ]);    }    private function paymentSuccess( array $cartIds , $tapId = null , $paymentMethod): void    {        foreach ($cartIds as $bookingId) {            BookingTransaction::create([                'booking_id'     => $bookingId,                'external_transaction_id' => $tapId,                'transaction_type' => $paymentMethod,                'payment_status' => 1,            ]);        }    }}